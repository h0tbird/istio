#!/bin/bash

#------------------------------------------------------------------------------
# Functions
#------------------------------------------------------------------------------

function getComponent {
  [ "$1" == "EastWestGateway" ] && { echo IngressGateways; exit; }
  echo "$1"
}

function getConfig {
  [ "$1" == "EastWestGateway" ] && { echo "-f ./config/iop-ewgw.yaml"; exit; }
  echo "-f ./config/iop-igws.yaml"
}

function generate {
  istioctl-"$1" manifest generate \
    --component "$(getComponent "$2")" \
    -f ./config/iop-base.yaml \
    -f ./config/iop-cni.yaml \
    -f ./config/iop-pilot.yaml \
    "$(getConfig "$2")" |
  sed '
    s/cluster-XXXX/{{ .Values.cluster }}/g;
    s/domain-XXXX/{{ .Values.domain }}/g;
    s/network-XXXX/{{ .Values.network }}/g;
    s/mesh-XXXX/{{ .Values.mesh }}/g;
    s/revision-XXXX/{{ .Values.revision }}/g;
  '
}

#------------------------------------------------------------------------------
# Generate yaml for the given version and component
#------------------------------------------------------------------------------

generate 1-16-0 Base > charts/base/templates/generated.yaml
generate 1-16-0 Cni > charts/cni/templates/generated.yaml
generate 1-16-0 Pilot > charts/pilot/templates/generated.yaml
generate 1-16-0 IngressGateways > charts/igws/templates/generated.yaml
generate 1-16-0 EastWestGateway > charts/ewgw/templates/generated.yaml
